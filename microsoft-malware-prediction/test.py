import pandas as pd
import glob
import shutil
import sys
import numpy as np
from IPython.display import display, HTML
import matplotlib.pyplot as plt
import math
from time import time
from sklearn.impute import SimpleImputer
from sklearn.naive_bayes import GaussianNB
from sklearn.metrics import accuracy_score
from sklearn.metrics import fbeta_score
from sklearn.model_selection import train_test_split
import pickle
import os
from past.builtins import execfile

from process_df import process_df

file = 'data/test.csv'
test_df = pd.read_csv(file)
print("Read file done")


# Split the data in features and target label
s1 = test_df['MachineIdentifier']
test_df = test_df.drop('MachineIdentifier', axis=1)

test_df = process_df(test_df)
print(test_df.shape)

# https://stackoverflow.com/questions/43579180/feature-names-must-be-unique-xgboost
test_df = test_df.loc[:,~test_df.columns.duplicated()]

# https://stackoverflow.com/questions/42338972/valueerror-feature-names-mismatch-in-xgboost-in-the-predict-function
with open('train_df_columns.pkl', 'rb') as f:
    train_df_columns = pickle.load(f)
test_df = test_df[train_df_columns]
print("Change column names done")


with open('trained_model.pkl', 'rb') as f:
    trained_model = pickle.load(f)

predictions_test = trained_model.predict(test_df)
print('Prediction done')


# In[35]:


s2 = pd.Series(predictions_test)
submission = pd.concat([s1, s2], axis=1)
submission.columns = ['MachineIdentifier', 'HasDetections']
print('Store submission done')
# submission = pd.DataFrame([s1, s2], columns=['MachineIdentifier','HasDetections'])
# print(s1.shape)
# print(s2.shape)
# print(submission.shape)
# print(submission.columns)


# In[37]:


submission.to_csv('results.csv', index=False)

print('Test prediction done')
